name: terraform-app-mlops

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  terraform:
    runs-on: ubuntu-latest

    # IMPORTANT: id-token: write -> needed for WIF
    permissions:
      contents: read
      id-token: write

    env:
      GCP_PROJECT_ID: "mlops-448320"
      WIF_PROVIDER: "${{ secrets.GCP_WIF_PROVIDER }}" # we'll set this below
      GSA_EMAIL:  "${{ secrets.GCP_GSA_EMAIL }}"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Authenticate to GCP using Workload Identity Federation
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER }}
          service_account: ${{ env.GSA_EMAIL }}

      # Install gcloud
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      # Simple test â€“ list buckets
      - name: Test GCP access
        run: |
          gcloud storage ls || echo "No buckets or insufficient permissions"

      # # OPTIONAL: Terraform
      # - name: Set up Terraform
      #   uses: hashicorp/setup-terraform@v3

      # - name: Terraform init & plan
      #   working-directory: infra   # change if your .tf files root is different
      #   run: |
      #     terraform init \
      #       -backend-config="bucket=my-tf-state-bucket" \
      #       -backend-config="prefix=envs/dev"

      #     terraform plan
